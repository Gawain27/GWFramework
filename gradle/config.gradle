/* =========================================================================
 * Read configSet + expose root-wide ext & helpers
 * ========================================================================= */
import groovy.json.JsonSlurper
import groovy.transform.Field
import org.apache.groovy.json.internal.LazyMap

@Field final String CONFIG_INI    = 'config.ini'
@Field final String CONFIG_FOLDER = 'configs'

static String norm(Object o) { o == null ? null : o.toString().trim() }
static String normLower(Object o) { def s = norm(o); s ? s.toLowerCase(Locale.ROOT) : null }

// ----- locate configSet -----
String configSet = norm(project.findProperty('configSet'))
if (!configSet) {
  File ini = file(CONFIG_INI)
  if (ini.exists()) {
    Properties p = new Properties()
    ini.withReader { p.load(it) }
    configSet = norm(p.getProperty('config_set'))
  }
}
if (!configSet) throw new GradleException('‚ùå Pass -PconfigSet=<game> or define config.ini')

// (optional) enforce lowercase configSet if your filenames are lowercase
// configSet = configSet.toLowerCase(Locale.ROOT)

// ----- parse config -----
File cfgFile = file("${CONFIG_FOLDER}/${configSet}.json")
if (!cfgFile.exists()) throw new GradleException("‚ùå No such file $cfgFile")
Map parsedConfig = new JsonSlurper().parse(cfgFile) as Map

// ----- collect included modules (lowercase) -----
List<String> projectNames = (parsedConfig.projects ?: [])
  .collect { normLower(it.name) }
  .findAll { it }

List<Project> includedProjects = projectNames.collect { project(":${it}") } + project(':gwstarter')

ext.includedProjects      = includedProjects
ext.includedProjectNames  = (includedProjects*.name).collect { it.toString().toLowerCase(Locale.ROOT) }.toSet()
ext.parsedConfig          = parsedConfig as LazyMap
ext.configSet             = configSet
ext.translationKeysGlobal = [:]          // Map<String, String>
ext.projectLevels         = [:]

// ----- internationalisation locale list -----
String rawLocales = rootProject.findProperty('supportedLocales') ?: 'en_US'
ext.supportedLocales = rawLocales.split(',')*.trim() as List<String>
println "üåê Supported locales: ${supportedLocales}"

// ----- tool wiring (guarded) -----
def mapEditor = findProject(':tools:2d-map-editor')
if (mapEditor != null) {
  mapEditor.tasks.matching { it.name in ['run', 'runMap', 'runWorld'] }.configureEach { t ->
    if (t instanceof JavaExec) {
      File binDir = rootProject.layout.buildDirectory
        .dir("generatedConfig/${configSet}-${projectVersion}/bin")
        .get().asFile
      t.systemProperty 'gw.bin.dir', binDir.absolutePath
      t.systemProperty 'configSet', rootProject.configSet
      t.systemProperty 'gw.rootDir', rootProject.projectDir.absolutePath
    }
  }
}
