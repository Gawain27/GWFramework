/* =========================================================================
 * Common sub-project convention (plugins, Java version, JAR naming)
 * ========================================================================= */
subprojects { Project subproj ->
  if (!includedProjectNames.contains(subproj.name)) return

  apply plugin: 'java'
  apply plugin: 'java-library'
  apply plugin: 'idea'
  apply plugin: 'eclipse'

  sourceCompatibility = JavaVersion.VERSION_21
  targetCompatibility = JavaVersion.VERSION_21
  version = projectVersion                         // from gradle.properties

  plugins.withType(JavaPlugin).configureEach {
    // 1) Add a new configuration to hold testâ€classes
    configurations {
      testOutput
    }
    // 2) Create the JAR task from the test source set
    tasks.register('testJar', Jar) {
      archiveClassifier.set('tests')
      from sourceSets.test.output
    }
    // 3) Publish it on testOutput
    artifacts {
      testOutput testJar
    }
  }
  /* -------------------------------------------------------------- */
  // JAR naming and buildVersion bump on shipping builds
  /* -------------------------------------------------------------- */
  tasks.named('jar') { Jar jarTask ->
    if (rootProject.isShippingBuild) {
      dependsOn rootProject.tasks.named('bumpBuildVersions')
      outputs.upToDateWhen { false }           // force rebuild
    }
    doFirst {
      Properties p = new Properties()
      file("${projectDir}/gradle.properties").withInputStream { p.load(it) }
      archiveFileName.set("${subproj.name}-${p.getProperty('buildVersion')}.jar")
    }
  }
}
