/* =========================================================================
 *  bumpBuildVersions (runs before any jar task on shipping builds)
 * ========================================================================= */
import java.util.Properties

static String normName(Object o) {
  return o == null ? null : o.toString().trim().toLowerCase(Locale.ROOT)
}

Map<String, Integer> projectBuildVersions = [:]   // ext is implicit

// "build" is no longer a shipping build; delivery (and archive tasks) are.
ext.isShippingBuild = gradle.startParameter.taskNames.any { String t ->
  def n = (t ?: '').toLowerCase(Locale.ROOT)
  n == 'delivery' || n.endsWith(':delivery') ||
    n == 'zipdistribution' || n.endsWith(':zipdistribution') ||
    n == 'tardistribution' || n.endsWith(':tardistribution')
}

tasks.register('bumpBuildVersions') {
  doLast {
    println 'ðŸ”¼  bumpBuildVersions â€¦'

    includedProjects.each { Project prj ->
      String key = normName(prj.name)

      File propsFile = prj.file('gradle.properties')
      if (!propsFile.exists()) {
        // If a module has no gradle.properties, treat as buildVersion=0 and skip bumping.
        projectBuildVersions[key] = 0
        return
      }

      Properties props = new Properties()
      propsFile.withInputStream { props.load(it) }

      int buildVer = (props.getProperty('buildVersion') ?: '0').toInteger()

      File srcDir = prj.file('src')
      long latest = 0L
      if (srcDir.exists()) {
        def files = prj.fileTree(srcDir).files
        latest = files ? (files.max { it.lastModified() }?.lastModified() ?: 0L) : 0L
      }

      File stamp = prj.file('.lastVersionCheck')
      long previous = stamp.exists() ? (stamp.text.trim() ? stamp.text.trim().toLong() : 0L) : 0L

      if (latest > previous) {
        buildVer++
        props['buildVersion'] = buildVer.toString()
        propsFile.withOutputStream { props.store(it, null) }
        stamp.text = latest.toString()
        println "   â€¢ ${prj.name} â†’ buildVersion = $buildVer"
      }

      projectBuildVersions[key] = buildVer
    }
  }
}

/* helper so other scripts can ask for the current buildVersion --------- */
ext.buildVerOf = { String prjName ->
  String key = normName(prjName)

  Integer cached = projectBuildVersions[key]
  if (cached != null) return cached

  Properties props = new Properties()

  // Use normalized project path to match lowercased includes
  Project p = project(":${key}")
  File propsFile = new File(p.projectDir, 'gradle.properties')
  if (!propsFile.exists()) return 0

  propsFile.withInputStream { props.load(it) }
  return (props.getProperty('buildVersion') ?: '0').toInteger()
}
