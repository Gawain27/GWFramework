// ---------------------------------------------------------------------
// settings.gradle : Auto-generated behavior at settings phase
// Reads configs/<configSet>.json and includes projects accordingly.
// ---------------------------------------------------------------------
import groovy.json.JsonSlurper

rootProject.name = "GWFramework"

// ----- locate configSet (CLI -PconfigSet=..., or fallback to config.ini) -----
def CONFIG_INI = 'config.ini'
def CONFIG_FOLDER = 'configs'

def configSet = gradle.startParameter.projectProperties.get('configSet')
if (!configSet) {
  def ini = file(CONFIG_INI)
  if (ini.exists()) {
    def p = new Properties()
    ini.withReader { p.load(it) }
    configSet = p.getProperty('config_set')
  }
}
if (!configSet) {
  throw new GradleException('‚ùå Pass -PconfigSet=<game> or define config.ini')
}
println "‚úÖ settings: configSet = ${configSet}"

// ----- parse the JSON -----
def cfgFile = file("${CONFIG_FOLDER}/${configSet}.json")
if (!cfgFile.exists()) throw new GradleException("‚ùå No such file ${cfgFile}")
def parsed = new JsonSlurper().parse(cfgFile) as Map

def gameType = (parsed.gameType ?: '').toString()

// fixed modules we always include first
def fixed = ['gwstarter']

// collect projects from JSON (keep order, de-dupe)
def configNames = ((parsed.projects ?: [])*.name)
  .findAll { it }
  .collect { it.toString() }
  .unique()

// detect whether translation editor is requested
def wantTranslationEditor = gradle.startParameter.taskNames.any { t ->
  t == 'translationEditor' ||
    t.endsWith(':translationEditor') ||
    t == ':tools:translation-editor:run' ||
    t.endsWith(':tools:translation-editor:run')
}

def includes = (fixed + configNames)
  .collect { it.toString().toLowerCase(Locale.ROOT) }   // force lowercase
  .unique()

if (wantTranslationEditor) {
  includes += 'tools:translation-editor'
  println "üß© settings: translation editor requested -> including tools:translation-editor"
} else {
  println "üß© settings: translation editor not requested -> skipping tools:translation-editor"
}

println "üì¶ settings: including -> ${includes} (gameType='${gameType}')"
include(*includes as String[])

// any hardcoded includes should be lowercase too
include 'tools:2d-map-editor'
